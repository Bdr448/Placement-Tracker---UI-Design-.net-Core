@page "/student-dashboard"
@using BusinessLogic.Services
@using BusinessLogic.Models
@using Portal.UI.Services
@inject AuthState AuthState
@inject ApplicationService AppService
@inject CompanyService CompanyService
@inject NotificationService NotificationService
@inject NavigationManager Navigation

<PageTitle>Student Dashboard</PageTitle>

@if (!AuthState.IsAuthenticated || AuthState.UserRole != UserRole.Student)
{
    <div style="padding: 2rem;">
        <p>Access Denied. <NavLink href="/login">Login as Student</NavLink></p>
    </div>
}
else
{
    <div style="padding: 2rem;">
        <h1>Welcome @AuthState.UserName</h1>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px;">
                <h3 style="margin: 0;">Applications Sent</h3>
                <div style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">@myApplications.Count</div>
            </div>
            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.5rem; border-radius: 8px;">
                <h3 style="margin: 0;">Interviews Scheduled</h3>
                <div style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">@interviewApplications.Count</div>
            </div>
        </div>

        <div style="background: white; border-radius: 8px; padding: 2rem; margin-top: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2>Browse Companies</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                @foreach(var company in availableCompanies)
                {
                    <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                        <h3 style="margin: 0;">@company.Name</h3>
                        <p style="color: #666; margin: 0.5rem 0;">@company.Industry | @company.Location</p>
                        <div style="margin: 1rem 0; padding: 1rem 0; border-top: 1px solid #e2e8f0;">
                            <p style="margin: 0.5rem 0;"><strong>Package:</strong> â‚¹@company.AveragePackage.ToString("N0")</p>
                            <p style="margin: 0.5rem 0;"><strong>Positions:</strong> @company.OpenPositions</p>
                        </div>
                        <button @onclick="() => HandleApply(company.Id)" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Apply</button>
                    </div>
                }
            </div>
        </div>

        <div style="background: white; border-radius: 8px; padding: 2rem; margin-top: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2>My Applications</h2>
            @if (myApplications.Count > 0)
            {
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 1rem; text-align: left;">Company</th>
                            <th style="padding: 1rem; text-align: left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var app in myApplications)
                        {
                            var company = CompanyService.GetCompanyById(app.CompanyId);
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 1rem;">@company?.Name</td>
                                <td style="padding: 1rem;">@app.Status</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No applications yet. Browse and apply to companies!</p>
            }
        </div>
    </div>
}

@code {
    private List<Company> availableCompanies = new();
    private List<Application> myApplications = new();
    private List<Application> interviewApplications = new();

    protected override void OnInitialized()
    {
        if (!AuthState.IsAuthenticated || AuthState.UserRole != UserRole.Student)
        {
            Navigation.NavigateTo("/login");
        }
        else
        {
            LoadData();
        }
    }

    private void LoadData()
    {
        availableCompanies = CompanyService.GetAllCompanies();
        myApplications = AppService.GetApplicationsByStudent(AuthState.UserId ?? 0);
        interviewApplications = myApplications.Where(a => a.Status == ApplicationStatus.InterviewScheduled).ToList();
    }

    private void HandleApply(int companyId)
    {
        if (AppService.ApplyForCompany(AuthState.UserId ?? 0, companyId))
        {
            NotificationService.AddNotification(
                AuthState.UserId ?? 0,
                "Application Submitted",
                $"Applied successfully to {CompanyService.GetCompanyById(companyId)?.Name}",
                NotificationType.ApplicationStatus
            );
            LoadData();
        }
    }
}
