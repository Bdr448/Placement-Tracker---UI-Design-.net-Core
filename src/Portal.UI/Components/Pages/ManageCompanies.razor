@page "/manage-companies"
@using BusinessLogic.Services
@using BusinessLogic.Models
@using Portal.UI.Services
@inject AuthState AuthState
@inject CompanyService CompanyService
@inject NavigationManager Navigation

<PageTitle>Manage Companies - Placement Tracker</PageTitle>

@if (!AuthState.IsAuthenticated || AuthState.UserRole != UserRole.Admin)
{
    <div style="padding: 2rem; text-align: center;">
        <p>You don't have permission to access this page. <NavLink href="/login">Login as Admin</NavLink></p>
    </div>
}
else
{
    <div style="padding: 2rem;">
        <!-- Page Header -->
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1>Companies Management</h1>
                    <p>Manage all recruiting companies</p>
                </div>
                <button @onclick="ShowAddForm" class="btn btn-primary">+ Add New Company</button>
            </div>
        </div>

        <!-- Search and Filter -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <input type="text" @bind="SearchQuery" @bind:event="oninput" class="form-control" placeholder="Search companies..." style="max-width: 300px;" />
            <button @onclick="HandleSearch" class="btn btn-secondary">Search</button>
        </div>

        <!-- Add Company Form -->
        @if (ShowForm)
        {
            <div style="background: white; border-radius: 8px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h2>@(IsEditing ? "Edit Company" : "Add New Company")</h2>
                
                <form @onsubmit="HandleSubmit">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label>Company Name *</label>
                            <input type="text" @bind="FormData.Name" class="form-control" required />
                        </div>
                        <div>
                            <label>Industry *</label>
                            <input type="text" @bind="FormData.Industry" class="form-control" required />
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label>Email *</label>
                            <input type="email" @bind="FormData.Email" class="form-control" required />
                        </div>
                        <div>
                            <label>Phone *</label>
                            <input type="tel" @bind="FormData.Phone" class="form-control" required />
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label>Contact Person *</label>
                            <input type="text" @bind="FormData.ContactPerson" class="form-control" required />
                        </div>
                        <div>
                            <label>Location *</label>
                            <input type="text" @bind="FormData.Location" class="form-control" required />
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label>Website</label>
                            <input type="url" @bind="FormData.Website" class="form-control" />
                        </div>
                        <div>
                            <label>Average Package (‚Çπ)</label>
                            <input type="number" @bind="FormData.AveragePackage" class="form-control" />
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label>Open Positions *</label>
                            <input type="number" @bind="FormData.OpenPositions" class="form-control" required />
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label>Job Description *</label>
                        <textarea @bind="FormData.JobDescription" class="form-control" rows="3" required></textarea>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label>Requirements *</label>
                        <textarea @bind="FormData.Requirements" class="form-control" rows="3" required></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success">@(IsEditing ? "Update" : "Save")</button>
                        <button type="button" @onclick="CancelForm" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        }

        <!-- Companies List -->
        <div style="background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2>Active Companies</h2>
            
            @if (displayedCompanies.Count > 0)
            {
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                    @foreach(var company in displayedCompanies)
                    {
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; transition: box-shadow 0.3s;">
                            <h3 style="margin: 0 0 0.5rem 0; color: #333;">@company.Name</h3>
                            <p style="color: #666; margin: 0; font-size: 0.9rem;">@company.Industry</p>
                            
                            <div style="margin: 1rem 0; padding: 1rem 0; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                <p style="margin: 0.5rem 0;"><strong>üìß Email:</strong> @company.Email</p>
                                <p style="margin: 0.5rem 0;"><strong>üì± Phone:</strong> @company.Phone</p>
                                <p style="margin: 0.5rem 0;"><strong>üìç Location:</strong> @company.Location</p>
                                <p style="margin: 0.5rem 0;"><strong>üí∞ Avg Package:</strong> ‚Çπ@company.AveragePackage.ToString("N0")</p>
                                <p style="margin: 0.5rem 0;"><strong>üìä Open Positions:</strong> @company.OpenPositions</p>
                            </div>

                            <div style="margin: 1rem 0; padding: 0.75rem; background: #f0f7ff; border-radius: 4px; font-size: 0.85rem;">
                                <p style="margin: 0 0 0.5rem 0;"><strong>Job:</strong> @company.JobDescription</p>
                                <p style="margin: 0;"><strong>Requirements:</strong> @company.Requirements</p>
                            </div>

                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button @onclick="() => EditCompany(company)" class="btn btn-primary" style="flex: 1;">Edit</button>
                                <button @onclick="() => DeleteCompany(company.Id)" class="btn btn-danger" style="flex: 1;">Delete</button>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p style="color: #666; text-align: center; padding: 2rem;">No companies found</p>
            }
        </div>
    </div>
}

<style>
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #333;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
    }

    .page-header p {
        color: #666;
        margin: 0.5rem 0 0 0;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }
</style>

@code {
    private List<Company> companies = new();
    private List<Company> displayedCompanies = new();
    private Company FormData = new();
    private bool ShowForm = false;
    private bool IsEditing = false;
    private string SearchQuery = "";

    protected override void OnInitialized()
    {
        if (!AuthState.IsAuthenticated || AuthState.UserRole != UserRole.Admin)
        {
            Navigation.NavigateTo("/login");
        }
        else
        {
            LoadCompanies();
        }
    }

    private void LoadCompanies()
    {
        companies = CompanyService.GetAllCompanies();
        displayedCompanies = companies;
    }

    private void ShowAddForm()
    {
        FormData = new Company();
        IsEditing = false;
        ShowForm = true;
    }

    private void EditCompany(Company company)
    {
        FormData = new Company
        {
            Id = company.Id,
            Name = company.Name,
            Industry = company.Industry,
            Email = company.Email,
            Phone = company.Phone,
            ContactPerson = company.ContactPerson,
            Location = company.Location,
            Website = company.Website,
            AveragePackage = company.AveragePackage,
            OpenPositions = company.OpenPositions,
            JobDescription = company.JobDescription,
            Requirements = company.Requirements
        };
        IsEditing = true;
        ShowForm = true;
    }

    private void CancelForm()
    {
        ShowForm = false;
        FormData = new Company();
    }

    private void HandleSubmit()
    {
        if (IsEditing)
        {
            CompanyService.UpdateCompany(FormData);
        }
        else
        {
            CompanyService.AddCompany(FormData);
        }
        
        LoadCompanies();
        CancelForm();
    }

    private void DeleteCompany(int id)
    {
        if (companies.Any(c => c.Id == id))
        {
            CompanyService.DeleteCompany(id);
            LoadCompanies();
        }
    }

    private void HandleSearch()
    {
        if (string.IsNullOrEmpty(SearchQuery))
        {
            displayedCompanies = companies;
        }
        else
        {
            displayedCompanies = CompanyService.SearchCompanies(SearchQuery);
        }
    }
}
